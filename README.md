
# Курс по микросервисной архитектуре Artsofte

# Система управления подарочными картами

## 1. Функциональные требования

1. Система позволяет выпускать партии подарочных карт с параметрами: номинал, валюта, вендор, срок действия, количество.
2. Каждая карта имеет уникальный код, который хранится только в виде хэша (SHA256); поиск осуществляется по хэшу.
3. Карта может находиться в одном из статусов:  
   Available → Reserved → Activated, побочные: Blocked, Expired.
4. Нельзя активировать несуществующую, просроченную, заблокированную или уже активированную карту.
5. Система должна исключать двойную активацию (идемпотентность).
6. Все изменения статусов логируются в журнал (время, пользователь, операция).
7. Должна быть поддержка поиска и фильтрации карт, партий по статусу, сроку, вендору, номиналу и части кода.
8. Все запросы проходят валидацию данных. При ошибках возвращается подробное описание.
9. Система должна предоставлять метрики и /health эндпоинт для проверки состояния БД и сервисов.
10. Архитектура должна позволять расширение для взаимодействия сервисов.

## 2. Архитектура и сервисы

Система разделена на два микросервиса:

### **2.1 GiftCatalogApi (трёхслойная архитектура)**

**Назначение:** управляет всеми справочными и базовыми сущностями — вендорами, номиналами, партиями и картами.

**Функциональность:**
- Создание партий и автоматическая генерация карт.
- Просмотр, фильтрация и изменение статусов карт.
- Проверка карт по коду (для дальнейшей активации).
- Базовые CRUD-операции по справочникам.

**Слои:**
- Api
- Logic
- Dal

**REST:**
- POST /api/vendors — создать вендора
- GET /api/vendors/{id} — получить вендора
- GET /api/vendors — список вендоров (с фильтрацией и пагинацией)
- PUT /api/vendors/{id} — обновить вендора
- DELETE /api/vendors/{id} — удалить вендора
- POST /api/denominations — создать номинал
- GET /api/denominations/{id} — получить номинал
- GET /api/denominations — список номиналов
- PUT /api/denominations/{id} — обновить номинал
- DELETE /api/denominations/{id} — удалить номинал
- POST /api/batches — создать партию и сгенерировать карты
- GET /api/batches/{id} — получить информацию о партии
- GET /api/batches — список партий
- PUT /api/batches/{id}/close — закрыть партию
- GET /api/cards/{id} — получить карту
- GET /api/cards — список карт
- PUT /api/cards/{id}/block — заблокировать карту
- PUT /api/cards/{id}/unblock — разблокировать карту
- GET /health — проверить состояние сервиса

### **2.2 ActivationServiceApi (Onion-архитектура)**

**Назначение:** управляет процессом активации карты пользователем.

**Функциональность:**
- Создание и подтверждение активации.
- Проверка статуса карты через GiftCatalogApi.
- Логирование операций и ошибок.
- Обеспечение идемпотентности.

**Слои:**
- Api
- Services
- Domain
- Infrastructure

**REST:**
- POST /api/users — создать пользователя
- GET /api/users/{id} — получить пользователя
- GET /api/users — список пользователей
- POST /api/activations — создать активацию карты
- GET /api/activations/{id} — получить активацию
- GET /api/activations — список активаций
- GET /health — проверить состояние сервиса
- GET /api/audit/activation/{Id} - получить список событий по активации

## 3. System Design схема
<img width="542" height="193" alt="микросервисы drawio" src="https://github.com/user-attachments/assets/196d0a80-859f-4cd9-ab13-1187ece3cf55" />
